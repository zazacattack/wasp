"use strict";(self.webpackChunkweb=self.webpackChunkweb||[]).push([[465],{3905:(e,t,r)=>{r.d(t,{Zo:()=>p,kt:()=>f});var a=r(67294);function o(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function i(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,a)}return r}function n(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?i(Object(r),!0).forEach((function(t){o(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):i(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function s(e,t){if(null==e)return{};var r,a,o=function(e,t){if(null==e)return{};var r,a,o={},i=Object.keys(e);for(a=0;a<i.length;a++)r=i[a],t.indexOf(r)>=0||(o[r]=e[r]);return o}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)r=i[a],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(o[r]=e[r])}return o}var l=a.createContext({}),d=function(e){var t=a.useContext(l),r=t;return e&&(r="function"==typeof e?e(t):n(n({},t),e)),r},p=function(e){var t=d(e.components);return a.createElement(l.Provider,{value:t},e.children)},m="mdxType",c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var r=e.components,o=e.mdxType,i=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),m=d(r),u=o,f=m["".concat(l,".").concat(u)]||m[u]||c[u]||i;return r?a.createElement(f,n(n({ref:t},p),{},{components:r})):a.createElement(f,n({ref:t},p))}));function f(e,t){var r=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var i=r.length,n=new Array(i);n[0]=u;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[m]="string"==typeof e?e:o,n[1]=s;for(var d=2;d<i;d++)n[d]=r[d];return a.createElement.apply(null,n)}return a.createElement.apply(null,r)}u.displayName="MDXCreateElement"},83378:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>l,contentTitle:()=>n,default:()=>c,frontMatter:()=>i,metadata:()=>s,toc:()=>d});var a=r(87462),o=(r(67294),r(3905));r(44996);const i={title:"Middleware Customization"},n="Customizing Express server middleware",s={unversionedId:"guides/middleware-customization",id:"guides/middleware-customization",title:"Middleware Customization",description:"Wasp comes with a minimal set of useful Express middleware in every application. While this is good for most users, we realize some may wish to add, modify, or remove some of these choices both globally, or on a per-api/path basis.",source:"@site/docs/guides/middleware-customization.md",sourceDirName:"guides",slug:"/guides/middleware-customization",permalink:"/docs/guides/middleware-customization",draft:!1,editUrl:"https://github.com/wasp-lang/wasp/edit/main/web/docs/guides/middleware-customization.md",tags:[],version:"current",frontMatter:{title:"Middleware Customization"},sidebar:"docs",previous:{title:"Sending Emails",permalink:"/docs/guides/sending-emails"},next:{title:"Automatic CRUD",permalink:"/docs/guides/crud"}},l={},d=[{value:"Default global middleware",id:"default-global-middleware",level:2},{value:"Customization",id:"customization",level:2},{value:"Types",id:"types",level:3},{value:"1. Customize global middleware",id:"1-customize-global-middleware",level:2},{value:"2. Customize <code>api</code>-specific middleware",id:"2-customize-api-specific-middleware",level:2},{value:"3. Customize per-path middleware",id:"3-customize-per-path-middleware",level:2}],p={toc:d},m="wrapper";function c(e){let{components:t,...r}=e;return(0,o.kt)(m,(0,a.Z)({},p,r,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"customizing-express-server-middleware"},"Customizing Express server middleware"),(0,o.kt)("p",null,"Wasp comes with a minimal set of useful Express middleware in every application. While this is good for most users, we realize some may wish to add, modify, or remove some of these choices both globally, or on a per-",(0,o.kt)("inlineCode",{parentName:"p"},"api"),"/path basis."),(0,o.kt)("h2",{id:"default-global-middleware"},"Default global middleware"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://helmetjs.github.io/"},"Helmet"),": Helmet helps you secure your Express apps by setting various HTTP headers. It's not a silver bullet, but it can help!"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://github.com/expressjs/cors#readme"},"CORS"),": CORS is a package for providing a middleware that can be used to enable ",(0,o.kt)("a",{parentName:"li",href:"https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS"},"CORS")," with various options.",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"\u26a0\ufe0f This is required for the frontend to communicate with the backend."))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://github.com/expressjs/morgan#readme"},"Morgan"),": HTTP request logger middleware."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://expressjs.com/en/api.html#express.json"},"express.json")," (which uses ",(0,o.kt)("a",{parentName:"li",href:"https://github.com/expressjs/body-parser#bodyparserjsonoptions"},"body-parser"),"): Parses incoming request bodies in a middleware before your handlers, making the result available under the ",(0,o.kt)("inlineCode",{parentName:"li"},"req.body")," property.",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"\u26a0\ufe0f This is required for Wasp Operations to function properly."))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://expressjs.com/en/api.html#express.urlencoded"},"express.urlencoded")," (which uses ",(0,o.kt)("a",{parentName:"li",href:"https://expressjs.com/en/resources/middleware/body-parser.html#bodyparserurlencodedoptions"},"body-parser"),"): Returns middleware that only parses urlencoded bodies and only looks at requests where the ",(0,o.kt)("inlineCode",{parentName:"li"},"Content-Type")," header matches the type option."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://github.com/expressjs/cookie-parser#readme"},"cookieParser"),": Parse Cookie header and populate ",(0,o.kt)("inlineCode",{parentName:"li"},"req.cookies")," with an object keyed by the cookie names.")),(0,o.kt)("h2",{id:"customization"},"Customization"),(0,o.kt)("p",null,"You have three places where you can customize middleware:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"global: here, any changes will apply by default ",(0,o.kt)("em",{parentName:"li"},"to all operations (",(0,o.kt)("inlineCode",{parentName:"em"},"query")," and ",(0,o.kt)("inlineCode",{parentName:"em"},"action"),") and ",(0,o.kt)("inlineCode",{parentName:"em"},"api"),".")," This is helpful if you wanted to add support for multiple domains to CORS, for example. \u26a0\ufe0f Please treat modifications to global middleware with extreme care!"),(0,o.kt)("li",{parentName:"ol"},"per-api: you can override middleware for a specific api route (exe: ",(0,o.kt)("inlineCode",{parentName:"li"},"POST /webhook/callback"),"). This is helpful if you want to disable JSON parsing, for example."),(0,o.kt)("li",{parentName:"ol"},'per-path: this is helpful if you need to customize middleware for all methods for a given path. This is helpful for things like "complex CORS requests" which may need to apply to both ',(0,o.kt)("inlineCode",{parentName:"li"},"OPTIONS")," and ",(0,o.kt)("inlineCode",{parentName:"li"},"GET"),", or to apply some middleware to a ",(0,o.kt)("em",{parentName:"li"},"set of ",(0,o.kt)("inlineCode",{parentName:"em"},"api")," routes"),".")),(0,o.kt)("h3",{id:"types"},"Types"),(0,o.kt)("p",null,"Below are the relevant TS types and the actual definitions of default middleware."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"export type MiddlewareConfig = Map<string, express.RequestHandler>\n\nexport type MiddlewareConfigFn = (middlewareConfig: MiddlewareConfig) => MiddlewareConfig\n\nconst defaultGlobalMiddleware: MiddlewareConfig = new Map([\n  ['helmet', helmet()],\n  ['cors', cors({ origin: config.allowedCORSOrigins })],\n  ['logger', logger('dev')],\n  ['express.json', express.json()],\n  ['express.urlencoded', express.urlencoded({ extended: false })],\n  ['cookieParser', cookieParser()]\n])\n")),(0,o.kt)("h2",{id:"1-customize-global-middleware"},"1. Customize global middleware"),(0,o.kt)("p",null,"If you would like to modify the middleware for ",(0,o.kt)("em",{parentName:"p"},"all")," operations and APIs, you can do something like:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-wasp",metastring:"title=todoApp.wasp",title:"todoApp.wasp"},'app todoApp {\n  // ...\n\n  server: {\n    setupFn: import setup from "@server/serverSetup.js",\n    middlewareConfigFn: import { serverMiddlewareFn } from "@server/serverSetup.js"\n  },\n}\n')),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts",metastring:"title=src/server/serverSetup.ts",title:"src/server/serverSetup.ts"},"import cors from 'cors'\nimport { MiddlewareConfigFn } from '@wasp/middleware'\nimport config from '@wasp/config.js'\n\nexport const serverMiddlewareFn: MiddlewareConfigFn = (middlewareConfig) => {\n  // Example of adding an extra domains to CORS.\n  middlewareConfig.set('cors', cors({ origin: [config.frontendUrl, 'https://example1.com', 'https://example2.com'] }))\n  return middlewareConfig\n}\n")),(0,o.kt)("h2",{id:"2-customize-api-specific-middleware"},"2. Customize ",(0,o.kt)("inlineCode",{parentName:"h2"},"api"),"-specific middleware"),(0,o.kt)("p",null,"If you would like to modify the middleware for a single API, you can do something like:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-wasp",metastring:"title=todoApp.wasp",title:"todoApp.wasp"},'api webhookCallback {\n  fn: import { webhookCallback } from "@server/apis.js",\n  middlewareConfigFn: import { webhookCallbackMiddlewareFn } from "@server/apis.js",\n  httpRoute: (POST, "/webhook/callback"),\n  auth: false\n}\n')),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts",metastring:"title=src/server/apis.ts",title:"src/server/apis.ts"},"import express from 'express'\nimport { WebhookCallback } from '@wasp/apis/types'\nimport { MiddlewareConfigFn } from '@wasp/middleware'\n\nexport const webhookCallback: WebhookCallback = (req, res, _context) => {\n  res.json({ msg: req.body.length })\n}\n\nexport const webhookCallbackMiddlewareFn: MiddlewareConfigFn = (middlewareConfig) => {\n  console.log('webhookCallbackMiddlewareFn: Swap express.json for express.raw')\n  \n  middlewareConfig.delete('express.json')\n  middlewareConfig.set('express.raw', express.raw({ type: '*/*' }))\n\n  return middlewareConfig\n}\n\n")),(0,o.kt)("admonition",{type:"note"},(0,o.kt)("p",{parentName:"admonition"},"This gets installed on a per-method basis. Behind the scenes, this results in something like:"),(0,o.kt)("pre",{parentName:"admonition"},(0,o.kt)("code",{parentName:"pre",className:"language-js"},"router.post('/webhook/callback', webhookCallbackMiddleware, ...)\n"))),(0,o.kt)("h2",{id:"3-customize-per-path-middleware"},"3. Customize per-path middleware"),(0,o.kt)("p",null,"If you would like to modify the middleware for all API routes under some common path, you can do something like:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-wasp",metastring:"title=todoApp.wasp",title:"todoApp.wasp"},'apiNamespace fooBar {\n  middlewareConfigFn: import { fooBarNamespaceMiddlewareFn } from "@server/apis.js",\n  path: "/foo/bar"\n}\n')),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts",metastring:"title=src/server/apis.ts",title:"src/server/apis.ts"},"export const fooBarNamespaceMiddlewareFn: MiddlewareConfigFn = (middlewareConfig) => {\n  const customMiddleware : express.RequestHandler = (_req, _res, next) => {\n    console.log('fooBarNamespaceMiddlewareFn: custom middleware')\n    next()\n  }\n\n  middlewareConfig.set('custom.middleware', customMiddleware)\n\n  return middlewareConfig\n}\n")),(0,o.kt)("admonition",{type:"note"},(0,o.kt)("p",{parentName:"admonition"},"This gets installed at the router level for the path. Behind the scenes, this results in something like:"),(0,o.kt)("pre",{parentName:"admonition"},(0,o.kt)("code",{parentName:"pre",className:"language-js"},"router.use('/foo/bar', fooBarNamespaceMiddleware)\n"))))}c.isMDXComponent=!0}}]);